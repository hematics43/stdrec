<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Student Attendance System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; background:#f3f4f6; margin:0; padding:12px; }
    h1 { margin-bottom: 10px; font-size:1.3rem; }
    .controls { margin-bottom: 12px; display:flex; flex-wrap:wrap; gap:8px; }
    button { padding:6px 10px; border:none; border-radius:4px; cursor:pointer; font-size:0.85rem; }
    button.add { background:#2563eb; color:white; }
    button.format { background:#6b7280; color:white; }
    input[type="date"] { padding:6px; font-size:0.9rem; }

    .clock {
      position: fixed;
      top: 10px;
      right: 10px;
      background: #111827;
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: bold;
      z-index: 1000;
    }

    .table-wrap {
      overflow: auto;
      background:white;
      border-radius:6px;
      box-shadow:0 2px 6px rgba(0,0,0,0.1);
      max-height: 80vh;
      -webkit-overflow-scrolling: touch;
    }
    table { border-collapse: collapse; width:max-content; min-width:100%; font-size:0.85rem; }
    th, td {
      border:1px solid #ddd;
      padding:6px 4px;
      text-align:center;
      vertical-align:middle;
      white-space:nowrap;
      background:white;
    }
    th { background:#e5e7eb; position:sticky; top:0; z-index:3; font-size:0.8rem; }
    td.name { text-align:left; }

    /* freeze first 3 columns */
    th.sticky, td.sticky { position: sticky; left:0; z-index:4; background:#f9fafb; min-width:70px; }
    th.sticky2, td.sticky2 { position: sticky; left:70px; z-index:4; background:#f9fafb; min-width:60px; }
    th.sticky3, td.sticky3 { position: sticky; left:130px; z-index:4; background:#f9fafb; min-width:120px; }

    thead tr:nth-child(2) th { background:#f3f4f6; font-weight:normal; }
    thead tr:nth-child(3) th { background:#f9fafb; font-weight:normal; }

    .delete-btn { background:#ef4444; color:white; margin-left:5px; padding:2px 5px; font-size:0.7rem; }
    button.state-btn { width:26px; height:26px; border-radius:4px; border:1px solid #ccc; }
    .present { background:#22c55e; }
    .late { background:#facc15; }
    .absent { background:#ef4444; }
  </style>
</head>
<body>
  <div class="clock" id="liveClock">--:--:--</div>

  <h1>ðŸ“‹ Student Attendance</h1>

  <div class="controls">
    <input type="date" id="newDate" />
    <button class="add" onclick="addDate()">âž• Add Date</button>
    <button class="format" onclick="toggleDateFormat()">ðŸ“… Change Date Format</button>
  </div>

  <div class="table-wrap">
    <table id="attendanceTable">
      <thead>
        <tr id="headerRow">
          <th class="sticky">% Present</th>
          <th class="sticky2">Roll</th>
          <th class="sticky3">Name</th>
        </tr>
        <tr id="countRow">
          <th class="sticky"></th>
          <th class="sticky2"></th>
          <th class="sticky3"></th>
        </tr>
      </thead>
      <tbody id="studentRows"></tbody>
    </table>
  </div>

<script>
const STUDENTS = [
  {id:"01", name:"Aisha Khan"},
  {id:"02", name:"Rahul Verma"},
  {id:"03", name:"Sana Iqbal"},
  {id:"04", name:"Vikram Patel"},
  {id:"05", name:"Meera Joshi"},
  {id:"06", name:"Arjun Sharma"},
  {id:"07", name:"Priya Nair"},
  {id:"08", name:"Kabir Malhotra"},
  {id:"09", name:"Zoya Ansari"},
  {id:"10", name:"Rohan Gupta"}
];

let dates = [];
let attendanceData = {}; 
let dateFormat = 0; 

function formatDate(d){
  const dateObj = new Date(d);
  if(isNaN(dateObj)) return d;
  if(dateFormat===0){
    return d;
  } else if(dateFormat===1){
    return dateObj.toLocaleDateString("en-GB"); 
  } else {
    return dateObj.toLocaleDateString("en-US",{month:"short",day:"numeric"});
  }
}

function toggleDateFormat(){
  dateFormat = (dateFormat+1)%3;
  renderDates();
  saveToStorage();
}

function renderStudents(){
  const tbody = document.getElementById('studentRows');
  tbody.innerHTML = '';
  STUDENTS.forEach(s=>{
    const tr = document.createElement('tr');
    tr.dataset.id = s.id;
    tr.innerHTML = `
      <td class="sticky percent">0%</td>
      <td class="sticky2">${s.id}</td>
      <td class="sticky3 name">${s.name}</td>
    `;
    tbody.appendChild(tr);
  });
}

function addDate(date){
  const d = date || document.getElementById('newDate').value;
  if(!d){ alert("Please choose a date."); return; }
  if(dates.includes(d)){ alert("Date already added."); return; }
  dates.push(d);
  dates.sort();
  attendanceData[d] = attendanceData[d] || {};
  renderDates();
  saveToStorage();
}

function renderDates(){
  const headerRow = document.getElementById('headerRow');
  const countRow = document.getElementById('countRow');
  while(headerRow.cells.length > 3) headerRow.deleteCell(3);
  while(countRow.cells.length > 3) countRow.deleteCell(3);
  document.querySelectorAll('#studentRows tr').forEach(tr=>{
    while(tr.cells.length > 3) tr.deleteCell(3);
  });

  dates.forEach(d=>{
    const th = document.createElement('th');
    th.innerHTML = formatDate(d) + `<br><button class="delete-btn" onclick="deleteDate('${d}')">ðŸ—‘</button>`;
    headerRow.appendChild(th);

    const countTh = document.createElement('th');
    countTh.textContent = "P:0 / A:0 / L:0";
    countRow.appendChild(countTh);

    document.querySelectorAll('#studentRows tr').forEach(tr=>{
      const td = document.createElement('td');
      const roll = tr.dataset.id;
      const btn = document.createElement('button');
      btn.className="state-btn";

      btn.onclick = ()=>{
        cycleState(btn, d, roll);
        updateSummary();
        saveToStorage();
      };

      td.appendChild(btn);
      tr.appendChild(td);

      if(attendanceData[d] && attendanceData[d][roll]){
        cycleState(btn, d, roll, true);
      }
    });
  });

  updateSummary();
}

function cycleState(btn, d, roll, restore=false){
  const states = ["", "Present", "Late", "Absent"];
  let current = attendanceData[d][roll] || "";
  let idx = states.indexOf(current);
  if(!restore) idx = (idx+1) % states.length;
  let newState = states[idx];
  attendanceData[d][roll] = newState;

  btn.className = "state-btn";
  if(newState==="Present"){ btn.classList.add("present"); }
  else if(newState==="Late"){ btn.classList.add("late"); }
  else if(newState==="Absent"){ btn.classList.add("absent"); }
}

function updateSummary(){
  dates.forEach((d, idx)=>{
    let p=0,a=0,l=0;
    document.querySelectorAll('#studentRows tr').forEach(tr=>{
      const val = attendanceData[d][tr.dataset.id] || "";
      if(val==="Present") p++;
      else if(val==="Absent") a++;
      else if(val==="Late") l++;
    });
    document.getElementById('countRow').cells[3+idx].textContent = `P:${p} / A:${a} / L:${l}`;
  });

  document.querySelectorAll('#studentRows tr').forEach(tr=>{
    const roll = tr.dataset.id;
    let total = dates.length;
    let points = 0;
    dates.forEach(d=>{
      if(attendanceData[d]){
        if(attendanceData[d][roll]==="Present") points += 1;
        else if(attendanceData[d][roll]==="Late") points += 0.5;
      }
    });
    let percent = total>0 ? Math.round((points/total)*100) : 0;
    tr.querySelector('.percent').textContent = percent+"%";
  });
}

function deleteDate(date){
  if(confirm("Delete date "+formatDate(date)+" ?")){
    dates = dates.filter(d=>d!==date);
    delete attendanceData[date];
    renderDates();
    saveToStorage();
  }
}

function saveToStorage(){
  localStorage.setItem("attendanceDates", JSON.stringify(dates));
  localStorage.setItem("attendanceData", JSON.stringify(attendanceData));
  localStorage.setItem("dateFormat", dateFormat);
}

function loadFromStorage(){
  const savedDates = JSON.parse(localStorage.getItem("attendanceDates")||"[]");
  const savedData = JSON.parse(localStorage.getItem("attendanceData")||"{}");
  const savedFormat = localStorage.getItem("dateFormat");
  if(savedFormat!==null) dateFormat = parseInt(savedFormat);
  if(savedDates.length>0){
    dates = savedDates.sort();
    attendanceData = savedData;
    renderDates();
  }
}

// âœ… Pre-fill today in date picker
function setTodayInDatePicker(){
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth()+1).padStart(2,'0');
  const dd = String(today.getDate()).padStart(2,'0');
  document.getElementById("newDate").value = `${yyyy}-${mm}-${dd}`;
}

// Live Date & Time
function updateClock(){
  const now = new Date();
  const options = { weekday:'short', year:'numeric', month:'short', day:'numeric' };
  const dateStr = now.toLocaleDateString(undefined, options);
  const timeStr = now.toLocaleTimeString();
  document.getElementById('liveClock').textContent = dateStr + " " + timeStr;
}
setInterval(updateClock, 1000);
updateClock();

// init
renderStudents();
loadFromStorage();
setTodayInDatePicker(); 
</script>
</body>
</html>
