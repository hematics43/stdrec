<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>üìã Attendance System ‚Äî Final</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* Basic page */
    body { font-family: Arial, Helvetica, sans-serif; background:#f3f4f6; margin:0; padding:14px; color:#111; }
    h1 { margin:0 0 12px 0; font-size:1.25rem; }

    /* Controls */
    .controls, .add-student, .filters, .bottom-controls { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:12px; align-items:center; }
    input, select, button { padding:6px 8px; font-size:0.92rem; }
    button { border:0; border-radius:6px; cursor:pointer; }
    button.add { background:#2563eb; color:#fff; }
    button.format { background:#6b7280; color:#fff; }
    button.json { background:#10b981; color:#fff; }
    button.small { padding:4px 6px; font-size:0.85rem; }

    /* Clock */
    .clock { position: fixed; top: 10px; right: 10px; background:#111827; color:#fff; padding:6px 12px; border-radius:6px; z-index:2000; font-weight:600; font-size:0.85rem; }

    /* Table container */
    .table-wrap { overflow:auto; background:#fff; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.08); max-height:72vh; -webkit-overflow-scrolling: touch; padding:8px; }
    table { border-collapse:collapse; width:max-content; min-width:100%; font-size:0.88rem; }
    th, td { border:1px solid #e6e6e6; padding:6px 8px; text-align:center; vertical-align:middle; white-space:nowrap; background:#fff; }
    th { background:#eef2f6; position:sticky; top:0; z-index:5; font-weight:600; }

    td.name { text-align:left; }

    /* Sticky Roll + Name columns */
    .sticky-id { position:sticky; left:0;   z-index:6; background:#fbfefe; min-width:80px; text-align:center; }
    .sticky-name { position:sticky; left:80px; z-index:6; background:#fbfefe; min-width:220px; text-align:left; padding-left:10px; }

    /* Zebra striping + hover */
    #attendanceTable tbody tr:nth-child(odd) { background-color:#ffffff; }
    #attendanceTable tbody tr:nth-child(even) { background-color:#f9fafb; }
    #attendanceTable tbody tr:hover { background-color:#eaf6ff; }

    /* Buttons for states */
    .state-btn { padding:6px 8px; border-radius:6px; border:1px solid #cfcfcf; cursor:pointer; font-size:0.82rem; margin:0 3px; background:transparent; }
    .present { background:#16a34a; color:#fff; border-color:#16a34a; }
    .absent  { background:#ef4444; color:#fff; border-color:#ef4444; }
    .late    { background:#f59e0b; color:#000; border-color:#f59e0b; }

    /* Action buttons */
    .edit-btn { background:#f59e0b; color:#fff; padding:6px 8px; border-radius:6px; }
    .delete-btn { background:#ef4444; color:#fff; padding:6px 8px; border-radius:6px; }

    .actions-col { display:flex; gap:6px; justify-content:center; align-items:center; }

    /* Modal */
    .modal-overlay { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.45); z-index:3000; }
    .modal { background:#fff; padding:16px; border-radius:8px; width:92%; max-width:380px; box-shadow:0 10px 30px rgba(0,0,0,0.25); }
    .modal h2 { margin:0 0 8px 0; font-size:1.05rem; }
    .modal input, .modal select { width:100%; margin-bottom:8px; box-sizing:border-box; padding:8px; }
    .modal .actions { display:flex; gap:8px; justify-content:flex-end; }
    .btn-cancel { background:#6b7280; color:#fff; padding:8px 10px; border-radius:6px; border:none; cursor:pointer; }
    .btn-save   { background:#2563eb; color:#fff; padding:8px 10px; border-radius:6px; border:none; cursor:pointer; }

    /* Responsive small tweaks */
    @media (max-width:720px){
      .sticky-name { min-width:140px; left:70px; }
      .sticky-id { min-width:64px; }
      th, td { font-size:0.82rem; padding:6px 6px; }
    }
  </style>
</head>
<body>

  <div class="clock" id="liveClock">--</div>

  <h1>üìã Student Attendance</h1>

  <!-- Add Student -->
  <div class="add-student">
    <input id="studentRoll" placeholder="Roll No." />
    <input id="studentName" placeholder="Student Name" />
    <select id="studentClass">
      <option value="">Select Class</option>
      <option value="10A">10A</option>
      <option value="10B">10B</option>
      <option value="10C">10C</option>
      <option value="11A">11A</option>
      <option value="11B">11B</option>
      <option value="12A">12A</option>
    </select>
    <button class="add" onclick="addStudent()">‚ûï Add Student</button>
  </div>

  <!-- Filters + Sort -->
  <div class="filters">
    <label>Filter Class:
      <select id="filterClass" onchange="renderStudents()">
        <option value="all">All</option>
      </select>
    </label>

    <label>Sort By:
      <select id="sortBy" onchange="renderStudents()">
        <option value="roll">Roll No.</option>
        <option value="name">Name</option>
      </select>
    </label>
  </div>

  <!-- Date controls -->
  <div class="controls">
    <input type="date" id="newDate" />
    <button class="add" onclick="addDate()">‚ûï Add Date</button>
    <button class="format" onclick="toggleDateFormat()">üìÖ Change Date Format</button>
  </div>

  <div class="table-wrap">
    <table id="attendanceTable" role="table" aria-label="Attendance table">
      <thead>
        <tr id="headerRow">
          <th class="sticky-id">Roll</th>
          <th class="sticky-name">Name</th>
          <th>Class</th>
          <th>% Present</th>
          <th>Actions</th>
        </tr>
        <tr id="countRow">
          <th class="sticky-id"></th>
          <th class="sticky-name"></th>
          <th></th>
          <th></th>
          <th></th>
        </tr>
        <tr id="allRow">
          <th class="sticky-id"></th>
          <th class="sticky-name"></th>
          <th></th>
          <th></th>
          <th></th>
        </tr>
      </thead>
      <tbody id="studentRows"></tbody>
    </table>
  </div>

  <!-- bottom JSON controls -->
  <div class="bottom-controls">
    <button class="json" onclick="downloadJSON()">‚¨áÔ∏è Download JSON</button>
    <label class="json" style="display:inline-flex; align-items:center; gap:8px; cursor:pointer;">
      ‚¨ÜÔ∏è Upload JSON
      <input type="file" id="uploadJSON" accept="application/json" onchange="uploadJSON(event)" style="display:none;">
    </label>
  </div>

  <!-- Edit modal -->
  <div class="modal-overlay" id="editModal">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="editTitle">
      <h2 id="editTitle">Edit Student</h2>
      <input id="editRoll" placeholder="Roll No." />
      <input id="editName" placeholder="Name" />
      <select id="editClass">
        <option value="10A">10A</option>
        <option value="10B">10B</option>
        <option value="10C">10C</option>
        <option value="11A">11A</option>
        <option value="11B">11B</option>
        <option value="12A">12A</option>
      </select>
      <div class="actions">
        <button class="btn-cancel" onclick="closeModal()">Cancel</button>
        <button class="btn-save" onclick="saveEdit()">Save</button>
      </div>
    </div>
  </div>

<script>
/* --------------------------
   Data / state (initial demo students)
   -------------------------- */
let STUDENTS = [
  {id:"01", name:"Aisha Khan", cls:"10A"},
  {id:"02", name:"Rahul Verma", cls:"10A"},
  {id:"03", name:"Sana Iqbal", cls:"10B"}
];

let dates = []; // 'YYYY-MM-DD' array
let attendanceData = {}; // { "YYYY-MM-DD": { "<roll>": "Present"|"Late"|"Absent" } }
let dateFormat = 0; // 0=YYYY-MM-DD,1=DD/MM/YYYY,2=MMM dd
let editingStudentId = null;

/* --------------------------
   Helpers
   -------------------------- */
function escapeHtml(str){
  return String(str || '').replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[s]);
}
function formatDateDisplay(d){
  const dateObj = new Date(d);
  if(isNaN(dateObj)) return d;
  if(dateFormat === 0) return d;
  if(dateFormat === 1) return dateObj.toLocaleDateString('en-GB');
  return dateObj.toLocaleDateString('en-US', { month:'short', day:'numeric' });
}

/* --------------------------
   Render students (filter + sort)
   -------------------------- */
function renderStudents(){
  const tbody = document.getElementById('studentRows');
  tbody.innerHTML = '';

  const filterClass = document.getElementById('filterClass').value || 'all';
  const sortBy = document.getElementById('sortBy').value || 'roll';
  let list = [...STUDENTS];

  if(filterClass !== 'all') list = list.filter(s => s.cls === filterClass);
  if(sortBy === 'name') list.sort((a,b) => a.name.localeCompare(b.name));
  else list.sort((a,b) => a.id.localeCompare(b.id));

  list.forEach(s => {
    const tr = document.createElement('tr');
    tr.dataset.id = s.id;
    tr.innerHTML = `
      <td class="sticky-id">${escapeHtml(s.id)}</td>
      <td class="sticky-name">${escapeHtml(s.name)}</td>
      <td>${escapeHtml(s.cls)}</td>
      <td class="percent">0%</td>
      <td class="actions-col">
        <button class="edit-btn" type="button" onclick="openEdit('${escapeHtml(s.id)}')">‚úèÔ∏è</button>
        <button class="delete-btn" type="button" onclick="deleteStudent('${escapeHtml(s.id)}')">üóë</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  renderDates();
  updateSummary();
}

/* Update class filter dropdown */
function updateClassFilter(){
  const filter = document.getElementById('filterClass');
  const classes = Array.from(new Set(STUDENTS.map(s => s.cls))).filter(Boolean).sort();
  let html = `<option value="all">All</option>`;
  classes.forEach(c => html += `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`);
  filter.innerHTML = html;
}

/* --------------------------
   Student operations (add/edit/delete)
   -------------------------- */
function addStudent(){
  const roll = document.getElementById('studentRoll').value.trim();
  const name = document.getElementById('studentName').value.trim();
  const cls  = document.getElementById('studentClass').value;
  if(!roll || !name || !cls){ alert('Please enter Roll, Name and select Class'); return; }
  if(STUDENTS.some(s => s.id === roll)){ alert('Roll already exists'); return; }
  STUDENTS.push({ id: roll, name: name, cls: cls });
  document.getElementById('studentRoll').value = '';
  document.getElementById('studentName').value = '';
  document.getElementById('studentClass').value = '';
  updateClassFilter();
  renderStudents();
  saveToStorage();
}

function openEdit(roll){
  const st = STUDENTS.find(s => s.id === roll);
  if(!st) return;
  editingStudentId = st.id;
  document.getElementById('editRoll').value = st.id;
  document.getElementById('editName').value = st.name;
  document.getElementById('editClass').value = st.cls;
  document.getElementById('editModal').style.display = 'flex';
}
function closeModal(){
  editingStudentId = null;
  document.getElementById('editModal').style.display = 'none';
}
function saveEdit(){
  if(!editingStudentId) return;
  const st = STUDENTS.find(s => s.id === editingStudentId);
  if(!st) return;
  const newRoll = document.getElementById('editRoll').value.trim();
  const newName = document.getElementById('editName').value.trim();
  const newClass = document.getElementById('editClass').value;
  if(!newRoll || !newName || !newClass){ alert('Fill all fields'); return; }
  if(newRoll !== editingStudentId && STUDENTS.some(s => s.id === newRoll)){ alert('Roll already exists'); return; }

  // migrate attendance if roll changed
  if(newRoll !== st.id){
    dates.forEach(d => {
      if(attendanceData[d] && (st.id in attendanceData[d])){
        attendanceData[d][newRoll] = attendanceData[d][st.id];
        delete attendanceData[d][st.id];
      }
    });
    st.id = newRoll;
  }
  st.name = newName;
  st.cls = newClass;

  closeModal();
  updateClassFilter();
  renderStudents();
  saveToStorage();
}
function deleteStudent(roll){
  if(!confirm('Delete student with Roll ' + roll + ' ?')) return;
  STUDENTS = STUDENTS.filter(s => s.id !== roll);
  dates.forEach(d => { if(attendanceData[d]) delete attendanceData[d][roll]; });
  updateClassFilter();
  renderStudents();
  saveToStorage();
}

/* --------------------------
   Dates & attendance rendering
   -------------------------- */
function addDate(dateValue){
  const d = dateValue || document.getElementById('newDate').value;
  if(!d){ alert('Please pick a date'); return; }
  if(dates.includes(d)){ alert('Date already added'); return; }
  dates.push(d);
  dates.sort();
  attendanceData[d] = attendanceData[d] || {};
  renderDates();
  saveToStorage();
}
function deleteDate(dateStr){
  if(!confirm('Delete date ' + formatDateDisplay(dateStr) + ' ?')) return;
  dates = dates.filter(x => x !== dateStr);
  delete attendanceData[dateStr];
  renderDates();
  saveToStorage();
}

function renderDates(){
  const headerRow = document.getElementById('headerRow');
  const countRow  = document.getElementById('countRow');
  const allRow    = document.getElementById('allRow');

  // remove existing date header cells beyond the static 5 columns
  while(headerRow.cells.length > 5) headerRow.deleteCell(5);
  while(countRow.cells.length > 5) countRow.deleteCell(5);
  while(allRow.cells.length > 5) allRow.deleteCell(5);

  // remove date cells in each student row
  document.querySelectorAll('#studentRows tr').forEach(tr => {
    while(tr.cells.length > 5) tr.deleteCell(5);
  });

  // add date columns
  dates.forEach(d => {
    // header cell (date + delete)
    const th = document.createElement('th');
    th.innerHTML = `${escapeHtml(formatDateDisplay(d))}<br><button class="delete-btn small" style="padding:4px 6px;margin-top:6px;" onclick="deleteDate('${d}')">üóë</button>`;
    headerRow.appendChild(th);

    // counts row
    const cth = document.createElement('th');
    cth.textContent = 'P:0 / A:0 / L:0';
    countRow.appendChild(cth);

    // all-row: bulk buttons
    const allth = document.createElement('th');
    allth.innerHTML = `
      <button class="state-btn present small" onclick="setAll('${d}','Present')">All P</button>
      <button class="state-btn absent small" onclick="setAll('${d}','Absent')">All A</button>
      <button class="state-btn late small"   onclick="setAll('${d}','Late')">All L</button>
    `;
    allRow.appendChild(allth);

    // add cell per visible row (per student)
    document.querySelectorAll('#studentRows tr').forEach(tr => {
      const td = document.createElement('td');
      const roll = tr.dataset.id;
      td.innerHTML = `
        <button class="state-btn present" onclick="setState('${d}','${roll}','Present')">P</button>
        <button class="state-btn absent"  onclick="setState('${d}','${roll}','Absent')">A</button>
        <button class="state-btn late"    onclick="setState('${d}','${roll}','Late')">L</button>
      `;
      tr.appendChild(td);

      // restore saved state visual if exists (marking classes on buttons not necessary here; states stored)
      const saved = attendanceData[d] && attendanceData[d][roll];
      if(saved){
        // nothing extra required ‚Äî summary & percent reflect state
      }
    });
  });

  updateSummary();
}

/* set individual state for a student on a date */
function setState(d, roll, state){
  attendanceData[d] = attendanceData[d] || {};
  if(state) attendanceData[d][roll] = state;
  else delete attendanceData[d][roll];
  updateSummary();
  saveToStorage();
}

/* set all students for a date to a given state */
function setAll(d, state){
  attendanceData[d] = attendanceData[d] || {};
  STUDENTS.forEach(s => {
    attendanceData[d][s.id] = state;
  });
  updateSummary();
  saveToStorage();
}

/* --------------------------
   Summaries & percent
   -------------------------- */
function updateSummary(){
  // update counts per date (only counts overall STUDENTS, not filtered)
  dates.forEach((d, idx) => {
    let p=0,a=0,l=0;
    STUDENTS.forEach(s => {
      const val = (attendanceData[d] && attendanceData[d][s.id]) ? attendanceData[d][s.id] : "";
      if(val === 'Present') p++;
      else if(val === 'Late') l++;
      else if(val === 'Absent') a++;
    });
    const cell = document.getElementById('countRow').cells[5 + idx];
    if(cell) cell.textContent = `P:${p} / A:${a} / L:${l}`;
  });

  // percent per visible student (Late = 0.5)
  document.querySelectorAll('#studentRows tr').forEach(tr => {
    const roll = tr.dataset.id;
    const percentCell = tr.querySelector('.percent');
    let total = dates.length;
    let points = 0;
    dates.forEach(d => {
      const v = (attendanceData[d] && attendanceData[d][roll]) ? attendanceData[d][roll] : "";
      if(v === 'Present') points += 1;
      else if(v === 'Late') points += 0.5;
    });
    const pct = (total > 0) ? Math.round((points / total) * 100) : 0;
    if(percentCell) percentCell.textContent = pct + '%';
  });
}

/* --------------------------
   Import/Export + JSON
   -------------------------- */
function downloadJSON(){
  const payload = { STUDENTS, dates, attendanceData, dateFormat };
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type: 'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'attendance.json';
  a.click();
  URL.revokeObjectURL(a.href);
}
function uploadJSON(event){
  const file = event.target.files && event.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const obj = JSON.parse(e.target.result);
      if(!Array.isArray(obj.STUDENTS) || !Array.isArray(obj.dates) || typeof obj.attendanceData !== 'object') throw new Error('Invalid format');
      STUDENTS = obj.STUDENTS.map(s => ({ id: String(s.id), name: String(s.name), cls: String(s.cls || '') }));
      dates = obj.dates.slice().sort();
      attendanceData = obj.attendanceData || {};
      dateFormat = Number.isInteger(obj.dateFormat) ? obj.dateFormat : dateFormat;
      updateClassFilter();
      renderStudents();
      saveToStorage();
      alert('JSON imported successfully');
    } catch (err) {
      alert('Invalid JSON file: ' + (err.message || ''));
    } finally {
      event.target.value = '';
    }
  };
  reader.readAsText(file);
}

/* --------------------------
   Storage
   -------------------------- */
function saveToStorage(){
  try {
    localStorage.setItem('attendanceApp', JSON.stringify({ STUDENTS, dates, attendanceData, dateFormat }));
  } catch(e) { console.warn('save error', e); }
}
function loadFromStorage(){
  try {
    const raw = localStorage.getItem('attendanceApp');
    if(!raw) return;
    const obj = JSON.parse(raw);
    if(Array.isArray(obj.STUDENTS)) STUDENTS = obj.STUDENTS;
    if(Array.isArray(obj.dates)) dates = obj.dates;
    if(obj.attendanceData && typeof obj.attendanceData === 'object') attendanceData = obj.attendanceData;
    if(Number.isInteger(obj.dateFormat)) dateFormat = obj.dateFormat;
  } catch(e){ console.warn('load error', e); }
}

/* --------------------------
   Clock & datepicker
   -------------------------- */
function setTodayInDatePicker(){
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth()+1).padStart(2,'0');
  const dd = String(today.getDate()).padStart(2,'0');
  const el = document.getElementById('newDate');
  if(el) el.value = `${yyyy}-${mm}-${dd}`;
}
function startClock(){
  const el = document.getElementById('liveClock');
  function tick(){
    el.textContent = new Date().toLocaleString();
  }
  tick();
  setInterval(tick, 1000);
}

/* --------------------------
   Date format toggle
   -------------------------- */
function toggleDateFormat(){
  dateFormat = (dateFormat + 1) % 3;
  renderDates();
  saveToStorage();
}

/* --------------------------
   Init
   -------------------------- */
function init(){
  loadFromStorage();
  updateClassFilter();
  // Ensure at least today's date exists so columns show up immediately
  if(!dates || dates.length === 0){
    const t = new Date();
    const yyyy = t.getFullYear();
    const mm = String(t.getMonth()+1).padStart(2,'0');
    const dd = String(t.getDate()).padStart(2,'0');
    dates = [`${yyyy}-${mm}-${dd}`];
    attendanceData[dates[0]] = attendanceData[dates[0]] || {};
  }
  renderStudents();
  setTodayInDatePicker();
  startClock();
}
init();
</script>
</body>
</html>
