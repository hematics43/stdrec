<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Attendance Register</title>
  <style>
    body { font-family: "Segoe UI", Arial, sans-serif; margin:20px; background:#f9f9fb; color:#333; }
    h1 { text-align:center; margin-bottom:5px; }
    #liveClock { text-align:center; font-weight:bold; margin-bottom:20px; }

    .controls { display:flex; flex-wrap:wrap; gap:12px; justify-content:center; margin-bottom:15px; }
    .controls input, .controls select, .controls button { padding:6px 10px; border-radius:6px; border:1px solid #ccc; }
    button { cursor:pointer; background:#1976d2; color:white; border:none; transition:0.2s; }
    button:hover { background:#0d47a1; }
    .delete-btn { background:#e53935 !important; }
    .delete-btn:hover { background:#b71c1c !important; }
    .edit-btn { background:#f9a825 !important; }
    .edit-btn:hover { background:#f57f17 !important; }

    .table-container { overflow-x:auto; background:white; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
    table { border-collapse:collapse; width:100%; min-width:700px; }
    th,td { border:1px solid #ddd; padding:8px; text-align:center; }
    th { background:#f1f1f1; position:sticky; top:0; z-index:2; }
    tr:nth-child(even){ background:#fafafa; }
    tr:hover { background:#f0f8ff; }
    td:first-child, th:first-child { position:sticky; left:0; background:#f9f9fb; z-index:1; }

    .attendance-cell { cursor:pointer; font-weight:bold; transition:background 0.2s; }
    .status-P { background:#c8e6c9; color:#2e7d32; }
    .status-A { background:#ffcdd2; color:#c62828; }
    .status-Late { background:#ffe082; color:#f57f17; }

    .progress { height:16px; background:#eee; border-radius:8px; overflow:hidden; }
    .progress-bar { height:100%; background:#1976d2; color:white; font-size:0.75em; line-height:16px; text-align:center; transition:width 0.3s; }

    /* Modal */
    .modal-overlay { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.45); z-index:3000; }
    .modal { background:#fff; padding:16px; border-radius:8px; width:90%; max-width:360px; box-shadow:0 10px 30px rgba(0,0,0,0.25); }
    .modal h2 { margin:0 0 8px 0; font-size:1.1rem; }
    .modal input { width:100%; margin-bottom:8px; padding:8px; box-sizing:border-box; }
    .modal .actions { display:flex; gap:8px; justify-content:flex-end; }
    .btn-cancel { background:#6b7280; color:#fff; padding:8px 10px; border-radius:6px; border:none; cursor:pointer; }
    .btn-save { background:#1976d2; color:#fff; padding:8px 10px; border-radius:6px; border:none; cursor:pointer; }
  </style>
</head>
<body>
  <h1>Attendance Register</h1>
  <div id="liveClock"></div>

  <div class="controls">
    <label>Class:
      <select id="classFilter" onchange="renderStudents()">
        <option value="">All</option>
      </select>
    </label>
    <label>Date:
      <input type="date" id="newDate">
    </label>
    <button onclick="addDateFromPicker()">‚ûï Add Date</button>
    <button onclick="toggleDateFormat()">üîÑ Date Format</button>
    <input type="text" id="studentId" placeholder="ID">
    <input type="text" id="studentName" placeholder="Name">
    <input type="text" id="studentClass" placeholder="Class">
    <button onclick="addStudent()">‚ûï Add Student</button>
  </div>

  <div class="table-container">
    <table id="attendanceTable">
      <thead>
        <tr id="headerRow">
          <th>Student ID</th>
          <th>Name</th>
          <th>Class</th>
          <!-- dates go here -->
          <th>% Present</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="studentBody"></tbody>
    </table>
  </div>

  <!-- Edit modal -->
  <div class="modal-overlay" id="editModal">
    <div class="modal">
      <h2>Edit Student</h2>
      <input id="editId" placeholder="Student ID">
      <input id="editName" placeholder="Name">
      <input id="editClass" placeholder="Class">
      <div class="actions">
        <button class="btn-cancel" onclick="closeModal()">Cancel</button>
        <button class="btn-save" onclick="saveEdit()">Save</button>
      </div>
    </div>
  </div>

<script>
let STUDENTS = [];
let dates = [];
let attendanceData = {}; 
let dateFormat = 0;
let editingId = null;

function escapeHtml(t){return t.replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]));}
function formatDateDisplay(d){const dt=new Date(d); if(isNaN(dt)) return d; if(dateFormat===0) return dt.toLocaleDateString(); if(dateFormat===1) return dt.toISOString().slice(0,10); return dt.toDateString();}
function addStudent(){const id=document.getElementById('studentId').value.trim(); const name=document.getElementById('studentName').value.trim(); const cls=document.getElementById('studentClass').value.trim(); if(!id||!name) return alert("Enter ID and Name"); if(STUDENTS.some(s=>s.id===id)) return alert("Duplicate ID"); STUDENTS.push({id,name,cls}); saveToStorage(); updateClassFilter(); renderStudents(); document.getElementById('studentId').value='';document.getElementById('studentName').value='';document.getElementById('studentClass').value='';}
function deleteStudent(id){if(!confirm("Delete student?")) return; STUDENTS=STUDENTS.filter(s=>s.id!==id); delete attendanceData[id]; saveToStorage(); updateClassFilter(); renderStudents();}
function openEdit(id){const st=STUDENTS.find(s=>s.id===id); if(!st) return; editingId=id; document.getElementById('editId').value=st.id; document.getElementById('editName').value=st.name; document.getElementById('editClass').value=st.cls; document.getElementById('editModal').style.display="flex";}
function closeModal(){ editingId=null; document.getElementById('editModal').style.display="none"; }
function saveEdit(){ if(!editingId) return; const st=STUDENTS.find(s=>s.id===editingId); if(!st) return; const newId=document.getElementById('editId').value.trim(); const newName=document.getElementById('editName').value.trim(); const newClass=document.getElementById('editClass').value.trim(); if(!newId||!newName) return alert("Fill all fields"); if(newId!==editingId && STUDENTS.some(s=>s.id===newId)) return alert("Duplicate ID"); // migrate attendance
  if(newId!==st.id){ attendanceData[newId]=attendanceData[st.id]||{}; delete attendanceData[st.id]; st.id=newId; }
  st.name=newName; st.cls=newClass; saveToStorage(); updateClassFilter(); renderStudents(); closeModal(); }

function addDateFromPicker(){const d=document.getElementById('newDate').value; if(!d) return; if(!dates.includes(d)){dates.push(d);dates.sort();saveToStorage();renderDates();}}
function deleteDate(d){if(!confirm("Delete date column?")) return; dates=dates.filter(x=>x!==d); for(const id in attendanceData){delete attendanceData[id][d];} saveToStorage(); renderDates();}
function renderDates(){const headerRow=document.getElementById('headerRow'); headerRow.innerHTML='<th>Student ID</th><th>Name</th><th>Class</th>'; dates.forEach(d=>{const th=document.createElement('th'); th.innerHTML=`${escapeHtml(formatDateDisplay(d))}<br><button class="delete-btn" onclick="deleteDate('${d}')">üóë</button>`; headerRow.appendChild(th);}); headerRow.innerHTML+='<th>% Present</th><th>Action</th>'; renderStudents();}
function renderStudents(){const body=document.getElementById('studentBody'); body.innerHTML=''; const filter=document.getElementById('classFilter').value; const list=STUDENTS.filter(s=>!filter||s.cls===filter); list.forEach(s=>{const tr=document.createElement('tr'); tr.innerHTML=`<td>${escapeHtml(s.id)}</td><td>${escapeHtml(s.name)}</td><td>${escapeHtml(s.cls||'')}</td>`; if(!attendanceData[s.id]) attendanceData[s.id]={}; dates.forEach(d=>{const val=attendanceData[s.id][d]||''; const td=document.createElement('td'); td.className='attendance-cell '+(val?('status-'+val):''); td.textContent=val; td.onclick=()=>cycleStatus(s.id,d,td); tr.appendChild(td);}); const pctCell=document.createElement('td'); pctCell.id='pct-'+s.id; tr.appendChild(pctCell); const action=document.createElement('td'); action.innerHTML=`<button class="edit-btn" onclick="openEdit('${s.id}')">‚úèÔ∏è</button> <button class="delete-btn" onclick="deleteStudent('${s.id}')">üóë</button>`; tr.appendChild(action); body.appendChild(tr); updatePercentage(s.id); });}
function cycleStatus(id,date,td){const order=['','P','A','Late']; let current=attendanceData[id][date]||''; let next=order[(order.indexOf(current)+1)%order.length]; attendanceData[id][date]=next; td.textContent=next; td.className='attendance-cell '+(next?('status-'+next):''); saveToStorage(); updatePercentage(id);}
function updatePercentage(id){const rec=attendanceData[id]||{}; let total=0,points=0; for(const d of dates){ if(rec[d]){ total++; if(rec[d]==='P') points+=1; else if(rec[d]==='Late') points+=0.5; }} const pct=(total>0)?Math.round((points/total)*100):0; const cell=document.getElementById('pct-'+id); if(cell) cell.innerHTML=`<div class="progress"><div class="progress-bar" style="width:${pct}%">${pct}%</div></div>`;}
function updateClassFilter(){const sel=document.getElementById('classFilter'); const current=sel.value; const classes=[...new Set(STUDENTS.map(s=>s.cls).filter(Boolean))].sort(); sel.innerHTML='<option value="">All</option>'+classes.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join(''); if([...sel.options].some(o=>o.value===current)) sel.value=current;}
function saveToStorage(){localStorage.setItem('attendanceStudents',JSON.stringify(STUDENTS));localStorage.setItem('attendanceDates',JSON.stringify(dates));localStorage.setItem('attendanceData',JSON.stringify(attendanceData));localStorage.setItem('attendanceDateFormat',String(dateFormat));}
function loadFromStorage(){try{const s=JSON.parse(localStorage.getItem('attendanceStudents')||'[]');const ds=JSON.parse(localStorage.getItem('attendanceDates')||'[]');const ad=JSON.parse(localStorage.getItem('attendanceData')||'{}');const df=localStorage.getItem('attendanceDateFormat'); if(Array.isArray(s)&&s.length) STUDENTS=s; if(Array.isArray(ds)&&ds.length) dates=ds.sort(); attendanceData=(ad&&typeof ad==='object')?ad:{}; if(df!==null) dateFormat=parseInt(df);}catch(e){console.warn('load error',e);} updateClassFilter(); renderStudents();}
function setTodayInDatePicker(){const t=new Date();const yyyy=t.getFullYear();const mm=String(t.getMonth()+1).padStart(2,'0');const dd=String(t.getDate()).padStart(2,'0');document.getElementById('newDate').value=`${yyyy}-${mm}-${dd}`;}
function updateClock(){const now=new Date();document.getElementById('liveClock').textContent=now.toLocaleString();}
setInterval(updateClock,1000); updateClock();
function toggleDateFormat(){dateFormat=(dateFormat+1)%3; renderDates(); saveToStorage();}
function initApp(){loadFromStorage();updateClassFilter();renderStudents();if(dates.length===0){const t=new Date();const yyyy=t.getFullYear();const mm=String(t.getMonth()+1).padStart(2,'0');const dd=String(t.getDate()).padStart(2,'0');addDate(`${yyyy}-${mm}-${dd}`);}else{renderDates();} setTodayInDatePicker();}
initApp();
</script>
</body>
</html>
